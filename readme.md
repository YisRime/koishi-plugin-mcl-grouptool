# koishi-plugin-mcl-grouptool

[![npm](https://img.shields.io/npm/v/koishi-plugin-mcl-grouptool?style=flat-square)](https://www.npmjs.com/package/koishi-plugin-mcl-grouptool)

MC 启动器群助手 - 专为 Minecraft 启动器群设计（自用）

## 项目结构

```
src/
├── index.ts                    # 插件入口文件
├── config/
│   └── schema.ts              # 配置模式定义
├── services/                  # 服务层
│   ├── commandService.ts      # 命令处理服务
│   ├── enhancedCommands.ts    # 增强的文件管理命令
│   ├── enhancedFileDownload.ts # 增强的文件下载服务
│   ├── eventHandler.ts        # 事件处理服务
│   ├── fileDetection.ts       # 文件识别服务
│   ├── forward.ts             # 消息转发服务
│   ├── keyword.ts             # 关键词服务
│   ├── launcher.ts            # 启动器服务
│   ├── messageService.ts      # OneBot 消息服务
│   └── ocr.ts                 # OCR 识别服务
├── types/                     # 类型定义
│   ├── config.ts              # 配置类型
│   └── launcher.ts            # 启动器类型
└── utils/                     # 工具类
    ├── enhancedFileRecord.ts  # 增强的文件记录管理
    └── message.ts             # 消息工具
```
- 🎯 **关键词自动回复**：支持正则表达式匹配的关键词回复系统
- 🚫 **防重复发送**：智能防止重复消息发送，避免刷屏
- 👥 **用户权限管理**：支持白名单用户管理
- 📝 **手动发送命令**：管理员可手动触发预设回复
- 📸 **图片OCR识别**：自动识别图片中的文字并进行关键词匹配
- 🔄 **消息转发功能**：支持将消息转发到指定群组，包含OCR内容转发

## 支持的启动器

| 启动器 | 技术支持群 | 支持群组 | 错误文件格式 |
|--------|------------|----------|--------------|
| HMCL | 666546887 | 633640264, 203232161, 201034984, 533529045, 744304553, 282845310, 482624681, 991620626, 657677715, 775084843 | minecraft-exported-crash-info-YYYY-MM-DDTHH-MM-SS.zip |
| PCL2 | 978054335 | 1028074835 | 错误报告-YYYY-M-D_HH.MM.SS.zip |
| BakaXL | 377521448 | 480455628, 377521448 | BakaXL-ErrorCan-XXXXXXXXXXXXXX.json |

### 命令列表

| 命令 | 参数 | 描述 | 权限要求 |
|------|------|------|----------|
| `send` | `<regexPattern> [target]` | 发送预设的关键词回复 | 白名单用户 |
| `send -l` | 无 | 查看关键词列表 | 白名单用户 |

#### 命令详细说明

- `<regexPattern>`：必需参数，在关键词配置中定义的正则表达式
- `[target]`：可选参数，可以是以下格式：
  - `@用户` - 直接@某个用户
  - `@123456789` - @加用户ID
  - `123456789` - 纯用户ID
- 如果指定了目标用户，消息会@该用户；否则根据配置决定是否@发送者
- 使用 `-l` 选项可以查看当前配置的关键词列表

### 工作原理

1. **群组识别**：插件会自动识别当前群组属于哪个启动器的支持群
2. **文件检测**：当用户上传文件时，插件会检查文件名是否匹配对应启动器的错误报告格式
3. **智能引导**：
   - 如果在正确的群上传对应启动器的错误文件：提示本群可以解决问题，并提供技术支持群
   - 如果在错误的群上传其他启动器的错误文件：提示本群不解决其他启动器问题，引导到对应技术支持群

## 配置选项

### 权限开关配置

- `ocrReply`: 启用图片识别（默认关闭）
- `fileReply`: 启用文件识别（默认开启）
- `keywordReply`: 启用关键词回复（默认开启）
- `enableForward`: 启用消息转发（默认关闭）
- `forwardOcr`: 转发图片识别内容（默认关闭）
- `forwardTarget`: 转发目标群号
- `cmdWhitelist`: 命令操作白名单用户列表

### 自动回复配置

- `preventDup`: 延迟发送提示（默认开启）
- `quote`: 回复时引用消息（默认开启）
- `mention`: 回复时@用户（默认关闭）

### 关键词配置

- `keywords`: 关键词回复配置列表
  - `regex`: 正则表达式
  - `reply`: 回复内容
- `ocrKeywords`: OCR 关键词配置列表
  - `regex`: 正则表达式
  - `reply`: 回复内容
- `fwdKeywords`: 转发关键词配置列表
  - `regex`: 正则表达式

## 图片识别与消息转发功能

### OCR 图片识别

插件支持自动识别群聊中发送的图片文字内容：

1. **自动OCR识别**：当用户发送图片时，插件会自动调用OCR接口识别图片中的文字
2. **关键词匹配**：对识别出的文字内容进行关键词匹配，触发相应的自动回复
3. **OCR关键词配置**：支持单独配置OCR专用的关键词和回复内容

### 消息转发功能

插件支持将群聊消息转发到指定目标：

1. **文本消息转发**：将文本消息转发到指定群组，包含发送者信息
2. **图片OCR转发**：对图片进行OCR识别后，将识别结果一同转发
3. **关键词过滤**：支持配置转发关键词，只转发匹配关键词的消息
4. **来源标记**：转发消息会包含发送者ID和来源群组信息

### 转发消息格式

转发的消息格式为：`发送者ID（来源群组）\n消息内容`

- 文本消息：直接转发原始文本内容
- 图片OCR：转发OCR识别出的文字内容

## 使用方法

### 命令使用

```text
send <regexPattern> [target]
```

- 发送预设的关键词回复，使用正则表达式匹配关键词配置
- 可指定目标用户（支持 @用户 或 用户ID）
- 仅白名单用户可使用

```text
send -l
```

- 查看当前配置的关键词列表
- 仅白名单用户可使用

### 自动功能

1. **错误文件检测**：当用户上传对应启动器的错误文件时，自动发送技术支持群信息
2. **关键词回复**：当消息匹配配置的关键词或正则表达式时，自动发送对应回复
3. **智能防重**：3秒内检测到技术支持群号时取消重复发送
4. **图片OCR识别**：自动识别图片中的文字并进行关键词匹配
5. **消息转发**：根据配置自动转发消息到指定群组，包含OCR内容

## 注意事项

1. **权限要求**：使用 `send` 命令需要在白名单中
2. **OCR功能**：需要机器人支持 OneBot v11 协议的 `ocr_image` API
3. **群组配置**：插件会根据内置的群组配置自动识别启动器类型
4. **正则表达式**：关键词回复支持正则表达式，但不区分大小写
5. **防重机制**：延迟发送功能会在3秒后发送消息，如果期间检测到相关群号则取消发送
